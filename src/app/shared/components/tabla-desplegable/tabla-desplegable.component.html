<table class="min-w-full border-collapse">
  <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0 z-10">
    <tr>
      <th class="px-6 py-3" style="width: 60px"></th>
      <th class="px-6 py-3" style="width: 120px">Envío ID</th>
      <th class="px-6 py-3" style="width: 150px">Remitente</th>
      <th class="px-6 py-3" style="width: 150px">Fecha de envío</th>
      <th class="px-6 py-3" style="width: 200px">Estado de revisión</th>
      <th style="width: 200px">Acciones</th>
    </tr>
  </thead>

  <tbody>
    <ng-container
      *ngFor="let revision of elementosRevision; trackBy: trackById"
    >
      <tr class="hover:bg-gray-50 border-b last:border-b-0">
        <!-- Botón expandir -->
        <td class="px-3 py-4 text-gray-700">
          <button
            type="button"
            class="size-8 border border-gray-300 rounded-full flex items-center justify-center hover:border-blue-500 hover:text-blue-500 transition"
            (click)="expandirFila(revision.columnas['id'])"
            [attr.aria-expanded]="filaExpandida === revision.columnas['id']"
          >
            <svg
              class="size-4 transition-transform duration-300"
              [class.rotate-180]="filaExpandida === revision.columnas['id']"
              fill="currentColor"
              viewBox="0 0 256 256"
            >
              <path
                d="M216.49,104.49l-80,80a12,12,0,0,1-17,0l-80-80a12,12,0,0,1,17-17L128,159l71.51-71.52a12,12,0,0,1,17,17Z"
              />
            </svg>
          </button>
        </td>

        <!-- Datos principales -->
        <td class="px-3 py-5">{{ revision.columnas["id"] }}</td>
        <td class="px-3 py-5">
          <div class="flex flex-col">
            <span class="font-medium text-gray-900">
              {{ revision.columnas["provincia"] }}
            </span>
            <span class="text-sm text-gray-500">
              {{ revision.columnas["remitente"] }}
            </span>
          </div>
        </td>
        <td class="px-3 py-5">{{ revision.columnas["fechaEnvio"] }}</td>

        <!-- Estado -->
        <td class="px-3 py-5">
          <div class="flex items-center gap-2">
            <span
              class="w-2 h-2 rounded-full"
              [ngClass]="statusColor(revision.columnas['estadoRevision'])"
            ></span>
            <span
              class="capitalize font-medium"
              [ngClass]="statusText(revision.columnas['estadoRevision'])"
            >
              {{ revision.columnas["estadoRevision"] }}
            </span>
          </div>
        </td>

        <!-- Acciones -->
        <td class="px-3 py-1">
          <!-- Botones de aprobar y rechazar carpeta -->
          <div class="flex flex-col gap-1">
            <div class="flex gap-1 justify-end">
              <button
                (click)="handleAprobarRevision(revision.columnas['id'])"
                class="bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-4 py-2 rounded-md"
              >
                Aprobar
              </button>

              <button
                (click)="handleRechazarRevision(revision.columnas['id'])"
                class="bg-red-600 hover:bg-red-700 text-white text-xs font-medium px-4 py-2 rounded-md"
              >
                Rechazar
              </button>
            </div>

            <!-- Botón aprobar seleccionados -->
            <div *ngIf="seleccionados.size > 0" class="flex justify-end">
              <button
                (click)="handleAprobarSeleccionados()"
                class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-4 py-2 rounded-md"
              >
                Aprobar {{ seleccionados.size }} seleccionados
              </button>
            </div>
          </div>
        </td>
      </tr>

      <!-- Fila expandida con contenido completo -->
      <tr
        *ngIf="filaExpandida === revision.columnas['id']"
        class="bg-gray-50 border-b"
      >
        <td colspan="7" class="px-6 py-4">
          <!-- Si existe la descripcion, mostrarla -->
          <p
            *ngIf="revision.columnas['observaciones']"
            class="text-gray-600 mb-4"
          >
            {{ revision.columnas["observaciones"] }}
          </p>

          <!-- Si es una carpeta, mostrar su jerarquia desde la carpeta raíz y sus hijos -->
          <ng-container *ngIf="carpetaRaiz || archivoRaiz">
            <div class="col-span-2 select-none">
              <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="p-4">
                  <div class="space-y-1">
                    <div
                      class="flex items-center p-2 hover:bg-gray-50 rounded-md cursor-pointer"
                      (dblclick)="
                        carpetaRaiz &&
                        carpetaRaiz.columnas['elemento'] === 'CARPETA'
                          ? expandirCarpeta(carpetaRaiz)
                          : handleVerArchivo(archivoRaiz!)
                      "
                    >
                      <!-- Checkbox para carpetaRaiz o archivoRaiz -->
                      <!-- <input
                        type="checkbox"
                        class="appearance-none w-4 h-4 border border-gray-400 rounded-full checked:bg-blue-600 checked:border-blue-600 focus:outline-none transition duration-150 cursor-pointer"
                        [checked]="isSelected(carpetaRaiz || archivoRaiz)"
                        (change)="toggleSeleccion(carpetaRaiz || archivoRaiz)"
                      /> -->
                      <div class="flex items-center">
                        <button
                          *ngIf="
                            carpetaRaiz &&
                            carpetaRaiz.columnas['elemento'] === 'CARPETA'
                          "
                          (click)="expandirCarpeta(carpetaRaiz)"
                          class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-700"
                        >
                          <svg
                            [class.rotate-90]="carpetaRaiz.expandido"
                            class="w-4 h-4 transition-transform duration-200"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M9 5l7 7-7 7"
                            />
                          </svg>
                        </button>

                        <div
                          *ngIf="
                            archivoRaiz &&
                            archivoRaiz.columnas['elemento'] === 'ARCHIVO'
                          "
                          class="w-6"
                        ></div>
                      </div>
                      <div class="w-8 h-8 mr-3">
                        <ng-container *ngIf="carpetaRaiz; else archivoIcono">
                          <svg-icon
                            src="assets/icons/folder.svg"
                            class="w-8 h-8"
                            [svgClass]="'fill-current text-gray-600'"
                          />
                        </ng-container>

                        <ng-template #archivoIcono>
                          <ng-container
                            [ngSwitch]="
                              archivoRaiz!.columnas['extension']?.toLowerCase()
                            "
                          >
                            <svg-icon
                              *ngSwitchCase="'pdf'"
                              src="assets/icons/filePdf.svg"
                              class="w-8 h-8"
                            />
                            <svg-icon
                              *ngSwitchCase="'docx'"
                              src="assets/icons/fileDocx.svg"
                              class="w-8 h-8"
                            />
                            <svg-icon
                              *ngSwitchCase="'doc'"
                              src="assets/icons/fileDocx.svg"
                              class="w-8 h-8"
                            />
                            <svg-icon
                              *ngSwitchCase="'xls'"
                              src="assets/icons/fileExcel.svg"
                              class="w-8 h-8"
                            />
                            <svg-icon
                              *ngSwitchCase="'xlsx'"
                              src="assets/icons/fileExcel.svg"
                              class="w-8 h-8"
                            />
                            <svg-icon
                              *ngSwitchCase="'jpg'"
                              src="assets/icons/fileImage.svg"
                              class="w-8 h-8"
                            />
                            <svg-icon
                              *ngSwitchCase="'jpeg'"
                              src="assets/icons/fileImage.svg"
                              class="w-8 h-8"
                            />
                            <svg-icon
                              *ngSwitchCase="'png'"
                              src="assets/icons/fileImage.svg"
                              class="w-8 h-8"
                            />
                            <svg-icon
                              *ngSwitchDefault
                              src="assets/icons/fileNone.svg"
                              class="w-8 h-8"
                            />
                          </ng-container>
                        </ng-template>
                      </div>

                      <div class="flex-1">
                        <div class="text-sm font-medium text-gray-900">
                          {{
                            carpetaRaiz
                              ? carpetaRaiz.columnas["nombre"]
                              : archivoRaiz!.columnas["nombre"]
                          }}
                        </div>
                        <div class="text-xs text-gray-500">
                          {{
                            carpetaRaiz
                              ? carpetaRaiz.columnas["elemento"]
                              : archivoRaiz!.columnas["elemento"]
                          }}
                          <span
                            *ngIf="
                              archivoRaiz &&
                              archivoRaiz.columnas['elemento'] === 'ARCHIVO'
                            "
                          >
                            ({{ archivoRaiz.columnas["extension"] }})
                          </span>
                        </div>
                      </div>

                      <div
                        *ngIf="carpetaRaiz && carpetaRaiz.cargando"
                        class="ml-2"
                      >
                        <svg
                          class="animate-spin h-5 w-5 text-gray-500"
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                        >
                          <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            stroke-width="4"
                          ></circle>
                          <path
                            class="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                          ></path>
                        </svg>
                      </div>
                    </div>
                  </div>

                  <!-- Hijos de la carpeta raíz, solo si está expandida -->
                  <div
                    class="ml-6 space-y-1"
                    *ngIf="carpetaRaiz && carpetaRaiz.expandido"
                  >
                    <ng-container
                      *ngIf="
                        !carpetaRaiz.cargando &&
                        carpetaRaiz.hijos &&
                        carpetaRaiz.hijos.length > 0
                      "
                    >
                      <ng-container *ngFor="let hijo of carpetaRaiz.hijos">
                        <div
                          class="flex items-center p-2 hover:bg-gray-50 rounded-md cursor-pointer"
                          (dblclick)="
                            hijo.columnas['elemento'] === 'ARCHIVO'
                              ? handleVerArchivo(hijo)
                              : expandirCarpeta(hijo)
                          "
                        >
                          <!-- Checkbox para hijo -->
                          <input
                            type="checkbox"
                            class="appearance-none w-4 h-4 border border-gray-400 rounded-full checked:bg-blue-600 checked:border-blue-600 focus:outline-none transition duration-150 cursor-pointer"
                            [checked]="isSelected(hijo)"
                            (change)="
                              toggleSeleccion(hijo, $event, carpetaRaiz)
                            "
                          />
                          <div class="flex items-center">
                            <button
                              *ngIf="hijo.columnas['elemento'] === 'CARPETA'"
                              (click)="expandirCarpeta(hijo)"
                              class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-700"
                            >
                              <svg
                                [class.rotate-90]="hijo.expandido"
                                class="w-4 h-4 transition-transform duration-200"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M9 5l7 7-7 7"
                                />
                              </svg>
                            </button>
                            <div
                              *ngIf="hijo.columnas['elemento'] === 'ARCHIVO'"
                              class="w-6"
                            ></div>
                          </div>

                          <div class="w-8 h-8 mr-3">
                            <ng-container
                              *ngIf="
                                hijo.columnas['elemento'] === 'CARPETA';
                                else archivoIcono
                              "
                            >
                              <svg-icon
                                src="assets/icons/folder.svg"
                                class="w-8 h-8"
                                [svgClass]="'fill-current text-gray-600'"
                              />
                            </ng-container>
                            <ng-template #archivoIcono>
                              <ng-container
                                [ngSwitch]="
                                  hijo.columnas['extension']?.toLowerCase()
                                "
                              >
                                <svg-icon
                                  *ngSwitchCase="'pdf'"
                                  src="assets/icons/filePdf.svg"
                                  class="w-8 h-8"
                                />
                                <svg-icon
                                  *ngSwitchCase="'docx'"
                                  src="assets/icons/fileDocx.svg"
                                  class="w-8 h-8"
                                />
                                <svg-icon
                                  *ngSwitchCase="'doc'"
                                  src="assets/icons/fileDocx.svg"
                                  class="w-8 h-8"
                                />
                                <svg-icon
                                  *ngSwitchCase="'xls'"
                                  src="assets/icons/fileExcel.svg"
                                  class="w-8 h-8"
                                />
                                <svg-icon
                                  *ngSwitchCase="'xlsx'"
                                  src="assets/icons/fileExcel.svg"
                                  class="w-8 h-8"
                                />
                                <svg-icon
                                  *ngSwitchCase="'jpg'"
                                  src="assets/icons/fileImage.svg"
                                  class="w-8 h-8"
                                />
                                <svg-icon
                                  *ngSwitchCase="'jpeg'"
                                  src="assets/icons/fileImage.svg"
                                  class="w-8 h-8"
                                />
                                <svg-icon
                                  *ngSwitchCase="'png'"
                                  src="assets/icons/fileImage.svg"
                                  class="w-8 h-8"
                                />
                                <svg-icon
                                  *ngSwitchDefault
                                  src="assets/icons/fileNone.svg"
                                  class="w-8 h-8"
                                />
                              </ng-container>
                            </ng-template>
                          </div>

                          <div class="flex-1">
                            <div class="text-sm font-medium text-gray-900">
                              {{ hijo.columnas["nombre"] }}
                            </div>
                            <div class="text-sm font-medium text-gray-500">
                              {{ hijo.columnas["elemento"] }}
                              <span
                                *ngIf="hijo.columnas['elemento'] === 'ARCHIVO'"
                                >({{ hijo.columnas["extension"] }})</span
                              >
                            </div>
                          </div>

                          <div *ngIf="hijo.cargando" class="ml-2">
                            <svg
                              class="animate-spin h-5 w-5 text-gray-500"
                              xmlns="http://www.w3.org/2000/svg"
                              fill="none"
                              viewBox="0 0 24 24"
                            >
                              <circle
                                class="opacity-25"
                                cx="12"
                                cy="12"
                                r="10"
                                stroke="currentColor"
                                stroke-width="4"
                              ></circle>
                              <path
                                class="opacity-75"
                                fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                              ></path>
                            </svg>
                          </div>
                        </div>

                        <!-- Subcarpetas -->
                        <div
                          *ngIf="
                            hijo.expandido &&
                            hijo.hijos &&
                            hijo.hijos.length > 0
                          "
                          class="ml-6 space-y-1"
                        >
                          <ng-container *ngFor="let sub of hijo.hijos">
                            <div
                              class="flex items-center p-2 hover:bg-gray-50 rounded-md cursor-pointer"
                              (dblclick)="
                                sub.columnas['elemento'] === 'ARCHIVO'
                                  ? handleVerArchivo(sub)
                                  : expandirCarpeta(sub)
                              "
                            >
                              <!-- Checkbox para sub -->
                              <input
                                type="checkbox"
                                class="appearance-none w-4 h-4 border border-gray-400 rounded-full checked:bg-blue-600 checked:border-blue-600 focus:outline-none transition duration-150 cursor-pointer"
                                [checked]="isSelected(sub)"
                                (change)="toggleSeleccion(sub, $event, hijo)"
                              />
                              <div class="flex items-center">
                                <button
                                  *ngIf="sub.columnas['elemento'] === 'CARPETA'"
                                  (click)="expandirCarpeta(sub)"
                                  class="w-6 h-6 flex items-center justify-center text-gray-500 hover:text-gray-700"
                                >
                                  <svg
                                    [class.rotate-90]="sub.expandido"
                                    class="w-4 h-4 transition-transform duration-200"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                  >
                                    <path
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M9 5l7 7-7 7"
                                    />
                                  </svg>
                                </button>
                                <div
                                  *ngIf="sub.columnas['elemento'] === 'ARCHIVO'"
                                  class="w-6"
                                ></div>
                              </div>

                              <div class="w-8 h-8 mr-3">
                                <ng-container
                                  *ngIf="
                                    sub.columnas['elemento'] === 'CARPETA';
                                    else archivoIcono
                                  "
                                >
                                  <svg-icon
                                    src="assets/icons/folder.svg"
                                    class="w-8 h-8"
                                    [svgClass]="'fill-current text-gray-600'"
                                  />
                                </ng-container>

                                <ng-template #archivoIcono>
                                  <ng-container
                                    [ngSwitch]="
                                      sub.columnas['extension']?.toLowerCase()
                                    "
                                  >
                                    <svg-icon
                                      *ngSwitchCase="'pdf'"
                                      src="assets/icons/filePdf.svg"
                                      class="w-8 h-8"
                                    />
                                    <svg-icon
                                      *ngSwitchCase="'docx'"
                                      src="assets/icons/fileDocx.svg"
                                      class="w-8 h-8"
                                    />
                                    <svg-icon
                                      *ngSwitchCase="'doc'"
                                      src="assets/icons/fileDocx.svg"
                                      class="w-8 h-8"
                                    />
                                    <svg-icon
                                      *ngSwitchCase="'xls'"
                                      src="assets/icons/fileExcel.svg"
                                      class="w-8 h-8"
                                    />
                                    <svg-icon
                                      *ngSwitchCase="'xlsx'"
                                      src="assets/icons/fileExcel.svg"
                                      class="w-8 h-8"
                                    />
                                    <svg-icon
                                      *ngSwitchCase="'jpg'"
                                      src="assets/icons/fileImage.svg"
                                      class="w-8 h-8"
                                    />
                                    <svg-icon
                                      *ngSwitchCase="'jpeg'"
                                      src="assets/icons/fileImage.svg"
                                      class="w-8 h-8"
                                    />
                                    <svg-icon
                                      *ngSwitchCase="'png'"
                                      src="assets/icons/fileImage.svg"
                                      class="w-8 h-8"
                                    />
                                    <svg-icon
                                      *ngSwitchDefault
                                      src="assets/icons/fileNone.svg"
                                      class="w-8 h-8"
                                    />
                                  </ng-container>
                                </ng-template>
                              </div>

                              <div class="flex-1">
                                <div class="text-sm font-medium text-gray-900">
                                  {{ sub.columnas["nombre"] }}
                                </div>
                                <div class="text-xs text-gray-500">
                                  {{ sub.columnas["elemento"] }}
                                  <span
                                    *ngIf="
                                      sub.columnas['elemento'] === 'ARCHIVO'
                                    "
                                    >({{ sub.columnas["extension"] }})</span
                                  >
                                </div>
                              </div>

                              <div *ngIf="sub.cargando" class="ml-2">
                                <svg
                                  class="animate-spin h-5 w-5 text-gray-500"
                                  xmlns="http://www.w3.org/2000/svg"
                                  fill="none"
                                  viewBox="0 0 24 24"
                                >
                                  <circle
                                    class="opacity-25"
                                    cx="12"
                                    cy="12"
                                    r="10"
                                    stroke="currentColor"
                                    stroke-width="4"
                                  ></circle>
                                  <path
                                    class="opacity-75"
                                    fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                  ></path>
                                </svg>
                              </div>
                            </div>
                          </ng-container>
                        </div>
                      </ng-container>
                    </ng-container>
                    <div
                      *ngIf="
                        carpetaRaiz &&
                        !carpetaRaiz.cargando &&
                        (!carpetaRaiz.hijos || carpetaRaiz.hijos.length === 0)
                      "
                      class="text-center py-4 text-gray-500"
                    >
                      No hay elementos en esta carpeta
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </td>
      </tr>
    </ng-container>

    <!-- Sin resultados -->
    <tr *ngIf="elementosRevision.length === 0">
      <td
        colspan="7"
        class="text-center py-6 text-gray-500 bg-gray-50 rounded-md"
      >
        No hay elementos para revisar.
      </td>
    </tr>
  </tbody>
</table>
